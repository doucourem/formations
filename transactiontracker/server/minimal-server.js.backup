import express from "express";
import session from "express-session";
import MemoryStore from "memorystore";
import compression from "compression";
import path from "path";
import { fileURLToPath } from "url";
import { eq } from "drizzle-orm";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const MemoryStoreSession = MemoryStore(session);

async function startDeploymentServer() {
  try {
    const app = express();
    
    // CORS headers for external access (identical to development)
    app.use((req, res, next) => {
      res.header('Access-Control-Allow-Origin', req.headers.origin || '*');
      res.header('Access-Control-Allow-Credentials', 'true');
      res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, PATCH, DELETE, OPTIONS');
      res.header('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept, Authorization');
      
      if (req.method === 'OPTIONS') {
        res.sendStatus(200);
      } else {
        next();
      }
    });

    // Compression and basic middleware
    app.use(compression({ level: 6 }));
    app.use(express.json());
    app.use(express.urlencoded({ extended: false }));

    // Session configuration identical to development
    app.use(session({
      secret: process.env.SESSION_SECRET || 'deployment-secret',
      name: 'connect.sid',
      resave: false,
      saveUninitialized: false,
      rolling: true,
      store: new MemoryStoreSession({
        checkPeriod: 86400000
      }),
      cookie: {
        secure: false,
        maxAge: 24 * 60 * 60 * 1000,
        httpOnly: true,
        sameSite: 'lax',
        path: '/'
      }
    }));

    // Session debugging middleware
    app.use((req, res, next) => {
      console.log('[SESSION] ID:', req.sessionID);
      console.log('[SESSION] User:', req.session?.user?.username || 'None');
      console.log('[SESSION] Cookie:', req.headers.cookie ? 'Present' : 'Missing');
      next();
    });

    // Initialize database and services
    try {
      console.log('[INIT] Initializing database...');
      const { initializeDatabase } = await import('./init-db.js');
      await initializeDatabase();
      console.log('âœ… Database initialized successfully');
    } catch (error) {
      console.error('âŒ Database initialization failed:', error);
      throw error;
    }

    try {
      console.log('[INIT] Initializing archive service...');
      const { archiveService } = await import('./archive-service.js');
      await archiveService.init();
      console.log('âœ… Archive service initialized');
    } catch (error) {
      console.error('âŒ Archive service initialization failed:', error);
      // Continue without archive service
    }

    // Load complete authentication routes
    try {
      const { registerRoutes } = await import('./routes.js');
      await registerRoutes(app);
      console.log('âœ… Complete authentication routes loaded successfully');
    } catch (error) {
      console.error('âŒ Failed to load complete routes:', error);
      
      // Load essential authentication with database access
      try {
        const { db } = await import('./db.js');
        const { users } = await import('../shared/schema.js');
        
        app.post('/api/auth/login', async (req, res) => {
          const { username, password } = req.body;
          
          console.log('[AUTH] Deployment login attempt for:', username);
          
          try {
            // Import eq function
            const { eq } = await import('drizzle-orm');
            
            // Query database for user
            const userList = await db.select().from(users).where(eq(users.username, username));
            const user = userList[0];
            
            if (!user) {
              console.log('[AUTH] User not found:', username);
              return res.status(401).json({ message: 'Nom d\'utilisateur ou mot de passe incorrect' });
            }
            
            if (!user.isActive) {
              console.log('[AUTH] User inactive:', username);
              return res.status(401).json({ message: 'Compte dÃ©sactivÃ©' });
            }
            
            // Check password against database
            const isPasswordCorrect = password === user.password;
            
            if (!isPasswordCorrect) {
              console.log('[AUTH] Password incorrect for:', username);
              return res.status(401).json({ message: 'Nom d\'utilisateur ou mot de passe incorrect' });
            }
            
            // Create session
            req.session.user = {
              id: user.id,
              firstName: user.firstName,
              lastName: user.lastName,
              username: user.username,
              role: user.role
            };
            
            console.log('[AUTH] Deployment login successful for:', username);
            res.json(req.session.user);
          } catch (error) {
            console.error('[AUTH] Database error during login:', error);
            res.status(500).json({ message: 'Erreur serveur' });
          }
        });

        app.get('/api/auth/me', (req, res) => {
          if (req.session?.user) {
            res.json(req.session.user);
          } else {
            res.status(401).json({ message: 'Non authentifiÃ©' });
          }
        });

        app.post('/api/auth/logout', (req, res) => {
          req.session.destroy(() => {
            res.json({ success: true });
          });
        });
        
        // Add essential API routes for user data access
        const { transactions, clients, systemSettings } = await import('../shared/schema.js');
        const { eq } = await import('drizzle-orm');
        
        // Auth middleware
        const requireAuth = (req, res, next) => {
          if (!req.session?.user) {
            return res.status(401).json({ message: "Authentication required" });
          }
          req.user = req.session.user;
          next();
        };

        // Admin middleware
        const requireAdmin = (req, res, next) => {
          if (!req.user || req.user.role !== 'admin') {
            return res.status(403).json({ message: "Access denied" });
          }
          next();
        };
        
        // User profile endpoint
        app.get('/api/user/profile', requireAuth, async (req, res) => {
          try {
            const userList = await db.select().from(users).where(eq(users.id, req.user.id));
            if (userList.length > 0) {
              res.json(userList[0]);
            } else {
              res.status(404).json({ message: 'User not found' });
            }
          } catch (error) {
            console.error('Error fetching user profile:', error);
            res.status(500).json({ message: 'Server error' });
          }
        });

        // User transactions endpoint
        app.get('/api/transactions/user', requireAuth, async (req, res) => {
          try {
            const userTransactions = await db.select().from(transactions).where(eq(transactions.userId, req.user.id));
            res.json(userTransactions);
          } catch (error) {
            console.error('Error fetching user transactions:', error);
            res.status(500).json({ message: 'Server error' });
          }
        });

        // Daily user stats endpoint
        app.get('/api/daily-user', requireAuth, async (req, res) => {
          try {
            const userTransactions = await db.select().from(transactions).where(eq(transactions.userId, req.user.id));
            const totalSent = userTransactions.reduce((sum, t) => sum + Number(t.amountFCFA), 0);
            const totalFees = userTransactions.reduce((sum, t) => sum + Number(t.feeAmount || 0), 0);
            
            res.json({
              totalSent,
              totalFees,
              transactionCount: userTransactions.length
            });
          } catch (error) {
            console.error('Error fetching daily user stats:', error);
            res.status(500).json({ message: 'Server error' });
          }
        });

        // User clients endpoint
        app.get('/api/clients/user', requireAuth, async (req, res) => {
          try {
            const userClients = await db.select().from(clients).where(eq(clients.userId, req.user.id));
            res.json(userClients);
          } catch (error) {
            console.error('Error fetching user clients:', error);
            res.status(500).json({ message: 'Server error' });
          }
        });

        // User can send check endpoint
        app.get('/api/user/can-send', requireAuth, async (req, res) => {
          try {
            const userList = await db.select().from(users).where(eq(users.id, req.user.id));
            const user = userList[0];
            
            if (!user) {
              return res.status(404).json({ message: 'User not found' });
            }

            // Calculate user debt
            const userTransactions = await db.select().from(transactions).where(eq(transactions.userId, req.user.id));
            const currentDebt = userTransactions.reduce((sum, t) => sum + Number(t.amountToPay || 0), 0);
            const debtThreshold = Number(user.personalDebtThresholdFcfa || 1000000);
            
            const canSend = currentDebt <= debtThreshold;
            const remainingCredit = debtThreshold - currentDebt;
            
            res.json({
              canSend,
              currentDebt: currentDebt.toFixed(2),
              debtThreshold: debtThreshold.toFixed(2),
              remainingCredit: remainingCredit.toFixed(2),
              message: canSend 
                ? `Vous pouvez effectuer des envois. CrÃ©dit restant: ${remainingCredit.toFixed(2)} FCFA`
                : `Limite de crÃ©dit dÃ©passÃ©e. DÃ©passement: ${Math.abs(remainingCredit).toFixed(2)} FCFA`
            });
          } catch (error) {
            console.error('Error checking user debt status:', error);
            res.status(500).json({ message: 'Server error' });
          }
        });

        // System settings endpoint
        app.get('/api/system/settings', requireAuth, async (req, res) => {
          try {
            const settings = await db.select().from(systemSettings).limit(1);
            res.json(settings[0] || {});
          } catch (error) {
            console.error('Error fetching system settings:', error);
            res.status(500).json({ message: 'Server error' });
          }
        });

        // Admin endpoints
        app.get('/api/users', requireAuth, requireAdmin, async (req, res) => {
          try {
            const allUsers = await db.select().from(users);
            res.json(allUsers);
          } catch (error) {
            console.error('Error fetching all users:', error);
            res.status(500).json({ message: 'Server error' });
          }
        });

        app.get('/api/stats/users', requireAuth, requireAdmin, async (req, res) => {
          try {
            // Get user stats with transaction summaries
            const allUsers = await db.select().from(users).where(eq(users.role, 'user'));
            const userStats = [];
            
            for (const user of allUsers) {
              const userTransactions = await db.select().from(transactions).where(eq(transactions.userId, user.id));
              const totalSent = userTransactions.reduce((sum, t) => sum + Number(t.amountFCFA), 0);
              const totalPaid = userTransactions.reduce((sum, t) => sum + Number(t.amountToPay), 0);
              
              userStats.push({
                id: user.id,
                name: `${user.firstName} ${user.lastName}`,
                email: user.username,
                totalSent,
                totalPaid,
                previousDebt: 0,
                currentDebt: totalPaid - totalSent
              });
            }
            
            res.json(userStats);
          } catch (error) {
            console.error('Error fetching user stats:', error);
            res.status(500).json({ message: 'Server error' });
          }
        });

        app.get('/api/stats/daily', requireAuth, requireAdmin, async (req, res) => {
          try {
            const allTransactions = await db.select().from(transactions);
            const totalSent = allTransactions.reduce((sum, t) => sum + Number(t.amountFCFA), 0);
            const totalPaid = allTransactions.reduce((sum, t) => sum + Number(t.amountToPay), 0);
            
            res.json({
              totalSent,
              totalPaid,
              globalDebt: totalPaid - totalSent
            });
          } catch (error) {
            console.error('Error fetching daily stats:', error);
            res.status(500).json({ message: 'Server error' });
          }
        });
        
        console.log('âœ… Essential authentication and API routes loaded');
      } catch (dbError) {
        console.error('âŒ Failed to load database authentication:', dbError);
        throw dbError;
      }
    }

    // Health check endpoint
    app.get('/health', (req, res) => {
      res.json({
        status: 'healthy',
        timestamp: new Date().toISOString(),
        uptime: process.uptime(),
        environment: process.env.NODE_ENV || 'production',
        port: process.env.PORT || '5000',
        session: {
          configured: true,
          secret: process.env.SESSION_SECRET ? 'Present' : 'Missing',
          store: 'MemoryStore'
        },
        database: {
          url: process.env.DATABASE_URL ? 'Present' : 'Missing'
        }
      });
    });

    // Authentication status endpoint
    app.get('/api/auth/status', (req, res) => {
      res.json({
        sessionId: req.sessionID,
        user: req.session?.user || null,
        authenticated: !!req.session?.user,
        cookie: req.headers.cookie ? 'Present' : 'Missing'
      });
    });

    // Serve static files
    app.use(express.static(path.join(__dirname, '../dist/public')));

    // Root endpoint - serve the main application
    app.get('/', (req, res) => {
      res.sendFile(path.join(__dirname, '../dist/public/index.html'));
    });

    // Catch-all route for SPA
    app.get('*', (req, res) => {
      res.sendFile(path.join(__dirname, '../dist/public/index.html'));
    });

    // Start server
    const port = process.env.PORT || 5000;
    const server = app.listen(port, '0.0.0.0', () => {
      console.log('ğŸš€ GesFinance Deployment Server Started');
      console.log(`ğŸ“ Address: http://0.0.0.0:${port}`);
      console.log('ğŸŒ External Access: ENABLED');
      console.log('ğŸ” Authentication: CONFIGURED');
      console.log('âœ… Ready for deployment');
    });

    // Keep server alive
    setInterval(() => {
      console.log('ğŸ”¥ Server alive:', new Date().toISOString());
    }, 30000);

    return server;
  } catch (error) {
    console.error('âŒ Server startup failed:', error);
    process.exit(1);
  }
}

// Start the deployment server
startDeploymentServer();
